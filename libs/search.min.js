'use strict';
const ROOT = window.location.origin + window.BLOG.ROOT
const ATOM = ROOT + 'search.json' || ROOT + 'content.json'
let searchTpl = $('#searchTpl').html()
$(function() {
    let $input = $('#search input')
    $input.on('keyup', () => {
        let _val = $input.val()
        search(_val)
    })
    $('body').on('click', () => {
        $input.val('')
        $('#search .result').find('li').remove()
    })
    // .change(() => {
    //     // console.log($input.val())
    //     if($input.val() === '') {
    //         $('#search .result').find('li').remove()
    //     }
    // }).blur(() => {
    //     if(/No content related to/.test($('#search .result li').text())) {
    //         $input.val('')
    //         $('#search .result').find('li').remove()
    //     }
    // })
})
function loadData(cb) {
    $.ajax({
        url: ATOM,
        dataType: 'json',
        success: cb
    })
}
function matcher(post, regExp) {
    // return post.title.match(regExp)
    //     || post.tags.some(tag => {
    //             return tag.name.match(regExp)
    //         })
    //     || post.text.match(regExp)
    return regExp.test(post.title)
        || post.tags.some(tag => {
                return regExp.test(tag.name)
            })
        || regExp.test(post.text)
}
function tpl(html, data) {
    return html.replace(/\{\w+\}/g, str => {
        let prop = str.replace(/\{|\}/g, '')
        return data[prop] || ''
    })
}
function render(data, key) {
    let searchHtml = ''
    if(data.length) {
        searchHtml = data.map(post => {
            return tpl(searchTpl, {
                // title: post.title,
                title: post.title.replace(post.title.match(new RegExp(key, 'gmi')), '<em>'+post.title.match(new RegExp(key, 'gmi'))+'</em>'),
                path: ROOT + post.path,
                // date: new Date(post.date).toLocaleDateString(),
                date: post.date,
                tags: post.tags.map(tag => {
                    // return '<span>'+tag.name+'</span>'
                    return '<span>'+tag.name.replace(tag.name.match(new RegExp(key, 'gmi')), '<em>'+tag.name.match(new RegExp(key, 'gmi'))+'</em>')+'</span>'
                }).join('')
            })
        }).join('')
        // console.log(searchHtml)
    } else {
        searchHtml = '<li class="no-found">No content related to <span>「'+key+'」</span> was found !</li>'
    }
    $('#search .result').html(searchHtml)
}
function search(key) {
    // let keyArr = key.replace(/\||，|\,}/g)
    let regExp = new RegExp(key.replace(/[]/g), 'gmi')
    loadData((data) => {
        console.log(data)
        let result = data.filter(post => {
            return matcher(post, regExp)
        })
        render(result, key)
    })
}




// !function(n){function t(r){if(e[r])return e[r].exports;var o=e[r]={i:r,l:!1,exports:{}};return n[r].call(o.exports,o,o.exports,t),o.l=!0,o.exports}var e={};t.m=n,t.c=e,t.i=function(n){return n},t.d=function(n,e,r){t.o(n,e)||Object.defineProperty(n,e,{configurable:!1,enumerable:!0,get:r})},t.n=function(n){var e=n&&n.__esModule?function(){return n.default}:function(){return n};return t.d(e,"a",e),e},t.o=function(n,t){return Object.prototype.hasOwnProperty.call(n,t)},t.p="",t(t.s=1)}([,function(n,t,e){"use strict";function r(n){$.ajax({url:l,dataType:"json",success:n})}function o(n,t){return t.test(n.title)||n.tags.some(function(n){return t.test(n.name)})||t.test(n.text)}function a(n,t){return n.replace(/\{\w+\}/g,function(n){return t[n.replace(/\{|\}/g,"")]||""})}function i(n,t){var e="";e=n.length?n.map(function(n){return a(s,{title:n.title.replace(n.title.match(new RegExp(t,"gmi")),"<em>"+n.title.match(new RegExp(t,"gmi"))+"</em>"),path:u+n.path,date:n.date,tags:n.tags.map(function(n){return"<span>"+n.name.replace(n.name.match(new RegExp(t,"gmi")),"<em>"+n.name.match(new RegExp(t,"gmi"))+"</em>")+"</span>"}).join("")})}).join(""):'<li class="no-found">No content related to <span>「'+t+"」</span> was found !</li>",$("#search .result").html(e)}function c(n){var t=new RegExp(n.replace(/[]/g),"gmi");r(function(e){i(e.filter(function(n){return o(n,t)}),n)})}var u=window.location.origin+window.BLOG.ROOT,l=u+"search.json"||u+"content.json",s=$("#searchTpl").html();$(function(){var n=$("#search input");n.on("keyup",function(){c(n.val())}),$("body").on("click",function(){n.val(""),$("#search .result").find("li").remove()})})}]);